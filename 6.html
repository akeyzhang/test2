<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>測試單頁</title>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"
            integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
            crossorigin="anonymous"></script>
    <script type="text/javascript" src="js/akeyfunction.js"></script>
    <script type="text/javascript" src="js/jquery.jexcel.js"></script>
    <link rel="stylesheet" type="text/css" href="css/jquery.jexcel.css"/>
    <script type="text/javascript" src="js/jquery.jcalendar.js"></script>
    <link rel="stylesheet" type="text/css" href="css/jquery.jcalendar.css"/>

</head>
<body>
<div id="delv2001">
    <div id="delv2001_toolbar1">
        <input type="button" id="button1" value="send"/>
    </div>
    <div id="delv2001_main">
        <span id="title1">出 貨 單</span>
        <br><br><br><br>
        出貨單號:<input type="text" name="delv_no" id="delv_no1" value=""/>
        出貨日期:<input type="date" name="delv_date" id="delv_date1" value=""/>
        客 戶:<input type="text" name="cust_no" id="cust_no1" list="delv2001_customerList"/>
        <datalist id="delv2001_customerList"></datalist>
        <br>
    </div>
    <hr>
    <div id="delv2001_detail">

    </div>
    <br><br><br><br><br>
    <footer id="delv2001_footer">
        <span id="fusername">用戶:</span>
    </footer>

</div>
</body>
</html>

<!--  ************************************************************************************* -->
<script>
    $(function () {
        var socket = new WebSocket(WSURL);

        //var teststr =[{"user_name":"akey","user_pass":"akey123"},{"user_name":"zcc","user_pass":"zccpass"},{"user_name":"zxr","user_pass":"123456"},{"user_name":"jhf","user_pass":"jhf123"},{"user_name":"admin","user_pass":"admin"},{"user_name":"test","user_pass":"admin"}];

        function messageHandler(tagstr) {
            var tag = tagstr.substring(0, tagstr.indexOf("#**#"));
            var resultStr = tagstr.substring(tagstr.indexOf("#**#") + 4);
            //alert(tag);
            //alert(resultStr);
            if (tag == "delv2001_customerList") {
                $("#delv2001_customerList").empty();
                var customers = JSON.parse(resultStr);
                if (customers.length > 0) {
                    for (i = 0; i < customers.length; i++) {
                        var item = customers[i];
                        $("#delv2001_customerList").append('<option label="' + item.cust_sname + '" value="' + item.cust_no + '"></option>');
                    }
                }
            }
            if (tag == "delv2001_detail") {
                //alert(resultStr);
                console.log("得到返回數據:", getCurrentDateTime());
                showDetail(resultStr);
            }

        }

        socket.onopen = function (event) {
            //socket.send("I am client");
        }

        socket.onmessage = function (event) {
            //console.log("client recived a message",event);
            //alert(event.data)
            messageHandler(event.data);
        }

        socket.onclose = function (event) {
            console.log("client tell you: socket closed!", event);
        }

        function send(event) {
            var tagstr = event.data.tag + "#**#" + event.data.sqlstr;
            //alert(tagstr);
            console.log("向後台發送sql語句:", getCurrentDateTime());
            socket.send(tagstr);
        }

        function showDetail(jsonstr) {
            var datastr = JSON.parse(trimDateTimeZone(jsonstr));
            console.log("去除時區信息:", getCurrentDateTime());

            var rstr = "[";
            var headtile = new Array("delv_no", "delv_date", "cust_no");
            for (var row in datastr) {
                rstr += "[";
                for (var key in headtile) {
                    rstr += "'" + datastr[row][headtile[key]] + "',";
                }
                rstr = rstr.substr(0, rstr.length - 1);
                rstr += "],"
            }
            rstr += "]";
            var data = eval(rstr);
            console.log("data生成完:", getCurrentDateTime());

            $('#delv2001_detail').jexcel({
                data: data,
                colHeaders: ['出貨單號', '出貨日期', '客戶'],
                colWidths: [100, 100, 50],
                columns: [
                    {type: 'text'},
                    {type: 'calendar', options: {format: 'YYYY/MM/DD'}},
                    {type: 'text'},
                ]
            });
            console.log("表格展示完成:", getCurrentDateTime());
            $('#delv2001_detail').jexcel('updateSettings',
                {
                    cells: function (cell, col, row) {
                        if (row % 2 == 0) {
                            $(cell).css('background', '#f6ffe6');
                        }
                    }
                });
            console.log("最終完成:",getCurrentDateTime());


        }


        $("#delv_date1").val(getCurrentDate());
        $("#cust_no1").focusin({
            tag: "delv2001_customerList",
            sqlstr: "select cust_no,cust_sname from customer order by cust_no;"
        }, send)

        $("#button1").click({
            tag: "delv2001_detail",
            sqlstr: "select delv_no,delv_date,cust_no from delvmain where upd_date>='2017-11-01' order by delv_date;"
        }, send);
        //$("#button1").click(teststr,showDetail);

        //data=[["aaa","bbb"],["ccc","ddd"],["eee","fff"],];


    })
</script>

<style>
    #delv2001 {
        margin-left: 15%;
    }

    #fusername {
        font-size: 9px;
        color: red;
        position: absolute;
        bottom: 5%;
        right: 30%;
    }

    #title1 {
        font-size: 32px;
        alignment: center;
        position: absolute;
        left: 40%;
        text-decoration: underline;
    }

    #delv_no1, #delv_date1, #cust_no1 {
        font-size = 12px;
        border: 0px;
        border-bottom: #000000 1px solid;
        width: 120px;
        margin-right: 20px;
    }

    #delv2001_detail {
        height: 400px;
        width: 600px;
        overflow: auto;
    }
</style>